#!/bin/bash

# Install MariaDB server
sudo apt-get update
sudo apt-get install -y mariadb-server

# Secure MariaDB installation
sudo mysql -u root <<MYSQL_SCRIPT
ALTER USER 'root'@'localhost' IDENTIFIED BY 'Hichem2024';
FLUSH PRIVILEGES;
MYSQL_SCRIPT

# Create database for Nextcloud
sudo mysql -u root -pHichem2024 -e "CREATE DATABASE nextcloud;"

# Create MySQL user for Nextcloud
sudo mysql -u root -pHichem2024 -e "CREATE USER 'nextcloud_user'@'localhost' IDENTIFIED BY 'hichem2024';"
sudo mysql -u root -pHichem2024 -e "GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud_user'@'localhost';"
sudo mysql -u root -pHichem2024 -e "FLUSH PRIVILEGES;"

# Add PPA for PHP
sudo add-apt-repository -y ppa:ondrej/php
sudo apt-get update

# Install required packages
sudo apt-get install -y \
  apache2 \
  php8.0 \
  libapache2-mod-php8.0 \
  php8.0-mysql \
  php8.0-xml \
  php8.0-mbstring \
  php8.0-curl \
  php8.0-zip \
  php8.0-gd \
  php8.0-intl \
  php8.0-bcmath \
  php8.0-gmp \
  wget \
  unzip \
  git \
  make \
  python3-pymysql

# Download Nextcloud 29.0.2
sudo wget -O /tmp/nextcloud-29.0.2.zip https://download.nextcloud.com/server/releases/nextcloud-29.0.2.zip

# Unzip Nextcloud
sudo unzip /tmp/nextcloud-29.0.2.zip -d /var/www/

# Set correct permissions on Nextcloud directory
sudo chown -R www-data:www-data /var/www/nextcloud

# Create Apache configuration for Nextcloud
sudo tee /etc/apache2/sites-available/nextcloud.conf >/dev/null <<EOF
<VirtualHost *:80>
  DocumentRoot /var/www/nextcloud
  ServerName localhost

  <Directory /var/www/nextcloud/>
    Options +FollowSymlinks
    AllowOverride All
    <IfModule mod_dav.c>
      Dav off
    </IfModule>
    SetEnv HOME /var/www/nextcloud
    SetEnv HTTP_HOME /var/www/nextcloud
  </Directory>

  ErrorLog \${APACHE_LOG_DIR}/error.log
  CustomLog \${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
EOF

# Enable Nextcloud site
sudo a2ensite nextcloud.conf

# Disable Apache Local config
sudo a2dissite 000-default

# Enable rewrite module
sudo a2enmod rewrite

# Restart Apache
sudo systemctl restart apache2

# Wait for Apache to restart
sleep 10

# Create admin account for Nextcloud
sudo -u www-data php /var/www/nextcloud/occ maintenance:install \
  --database "mysql" \
  --database-name "nextcloud" \
  --database-host "localhost" \
  --database-user "nextcloud_user" \
  --database-pass "hichem2024" \
  --admin-user "admin" \
  --admin-pass "admin_password"
